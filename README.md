# vcenter-connector

vcenter-connector is an OpenFaaS event connector built to consume events from vCenter from VMware vSphere.

With this project your functions can subscribe to events generated by the changes (i.e. events) in your vCenter installation - for instance a VM being created, turned on or deleted. This allows you to extend vCenter's functionality by writing functions to execute each time an event is fired. An example may be tagging a VM with the date it was last turned on or applying a tag showing which user made a change to an object. 

## Status

This project uses the [OpenFaaS Connector SDK](https://github.com/openfaas-incubator/connector-sdk).

The code is under **active development** and only suitable for early adopters. More examples and instructions for use in Kubernetes are being worked on, including improved handling of secrets (accounts and passwords).

**Note:** Currently only a pre-build Docker image is available (based on [PR#11](https://github.com/openfaas-incubator/vcenter-connector/pull/11)) and only [VM events](https://code.vmware.com/doc/preview?id=4206#/doc/vim.event.VmEvent.html) are supported.

## Example: vCenter Tagging Function

### Pre-reqs:

* [OpenFaaS](https://docs.openfaas.com/) running on a local or remote Kubernetes cluster (e.g. [kind](https://blog.alexellis.io/get-started-with-openfaas-and-kind/))
* An installation of vCenter (tested against 6.5)
* A vCenter user/service account with sufficient rights to perform the (tagging) action of the example function
* `docker` to run tools like `govc` if not installed on your machine already
* `git` to clone the function example
* `faas-cli` to deploy the function
* `kubectl` to deploy the connector

**Note:** Make sure that your OpenFaaS environment can reach vCenter as the tagging function performs API calls against vCenter.

### How it works:

Functions can subscribe to events in vCenter through the "topic" [annotations](https://docs.openfaas.com/reference/yaml/#function-annotations) applied through your `stack.yml` file.

I.e. in the following example we will subscribe to the event "vm.powered.on" by adding an annotation to our function of "vm.powered.on"

### Get started with the vCenter Tagging Function example

1) Create a category/tag to be attached to a VM when it is powered on. Since we need the unique tag ID (i.e. vSphere URN) we will use [govc](https://github.com/vmware/govmomi/tree/master/govc) for this job. You can also use vSphere APIs (REST/SOAP) to retrieve the URN.

```bash
# Run pre-build govc Docker image
docker run --rm -it embano1/govc:0ee42d3 sh

# Test connection to vCenter, ignore TLS warnings
export GOVC_INSECURE=true
export GOVC_URL='https://vcuser:vcpassword@vcenter.ip' 
./govc tags.ls

# If the connection is successful create a demo category/tag
./govc tags.category.create democat1
urn:...
./govc tags.create -c democat1 demotag1
urn:vmomi:InventoryServiceTag:019c0a9e-0672-48f5-ac2a-e394669e2916:GLOBAL
```
2) Take a note of the `urn:...` for `demotag1` as we will need it in a bit
3) In a separate terminal download the example function

```bash
git clone https://github.com/embano1/pytagfn
cd pytagfn
```

4) Configure the Python tagging function `stack.yaml`. The example cloned from Github already has the annotation to subscribe to VM power on events. More details in the [README](https://github.com/embano1/pytagfn/blob/master/README.md).

```yaml
environment:
    VC: vcenter.ip                      # must be reachable/resolvable from OpenFaaS
    VCUSERNAME: VCUSER                  # WIP: migration to secrets
    VCPASSWORD: VCPASSWORD              # WIP: migration to secrets
    # Replace TAGURN example below with the one you created with govc above
    TAGURN: urn:vmomi:InventoryServiceTag:019c0a9e-0672-48f5-ac2a-e394669e2916:GLOBAL 
    TAGACTION: attach                   # this function also supports detach
```

5) Deploy the function

```bash
faas-cli deploy -f stack.yml
Deploying: pytag-fn.

Deployed. 202 Accepted.
URL: http://127.0.0.1:8080/function/pytag-fn
```

6) Download and deploy the OpenFaaS vCenter Connector deployment manifest in a separate

```bash
git clone https://github.com/openfaas-incubator/vcenter-connector
cd vcenter-connector

# In yaml/kubernetes/connector-dep.yml modify the container args "-vcenter", "-vc-user" and "-vc-pass" accordingly
# Note: OpenFaaS "-gateway" URL should be fine as we assume the connector is deployed in the same namespace and Kubernetes DNS will resolve

# Deploy to Kubernetes in the OpenFaaS namespace
kubectl -n openfaas create -f yaml/kubernetes/connector-dep.yml

# Check the logs of the pod whether it successfully connects to vCenter and OpenFaaS
kubectl -n openfaas logs vcenter-connector-<...> -f
```

7) Generate a "Power On" event

```bash
# Note: This can be done in vCenter UI or via govc
# Pick a VM that is powered off and does not have already "demotag1", then in the running govc container power on the VM
./govc vm.power -on /Datacenter-North/vm/Nested-Pod/vesxi67-2

# Verify that the tag was correctly attached
./govc tags.attached.ls demotag1
VirtualMachine:vm-267
```

### Troubleshooting

If the tag was not correctly attached, verify:

- vCenter IP/username/password
- Permissions of the vCenter user
- Whether the components can talk to each other (connector to vCenter and OpenFaaS, function to vCenter)
- Check the logs:

```bash
kubectl -n openfaas logs vcenter-connector-<...> -f

# Successful log message in the OpenFaaS vCenter connector
2019/01/25 23:39:09 Message on topic: vm.powered.on
2019/01/25 23:39:09 Invoke function: pytag-fn
2019/01/25 23:39:10 Response [200] from pytag-fn
```
- Enable debugging in the function with `write_debug` and `read_debug` env vars in `stack.yaml`

```bash
kubectl -n openfaas-fn logs pytag-fn-<...> -f

# Successful log message in the OpenFaaS tagging function
2019/01/25 23:48:55 Forking fprocess.
2019/01/25 23:48:55 Query
2019/01/25 23:48:55 Path  /

{"status": "200", "message": "successfully attached tag on VM: vm-267"}
2019/01/25 23:48:56 Duration: 1.551482 seconds
```

## License

MIT

## Acknowledgements

Thanks to VMware's Doug MacEachern for the awesome [govmomi](https://github.com/vmware/govmomi) project providing Golang bindings for vCenter and the [vcsim simulator tool](https://github.com/vmware/govmomi/blob/master/vcsim/README.md).

Thanks to Karol StÄ™pniewski for showing me a demo of events being consumed in OpenFaaS via vCenter over a year ago at KubeCon in Austin. Parts of his "event-driver" originally developed in the Dispatch project have been adapted for this OpenFaaS event-connector including a method to convert camel case event names into names separated by a dot. I wanted to include this for compatibility between the two systems.

Other acknowledgements: Michael Gasch (VMware) and Ivana Yocheva (VMware).
